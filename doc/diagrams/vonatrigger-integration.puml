@startuml vonatrigger-integration
!theme plain
skinparam defaultFontName "Noto Sans CJK JP"
skinparam backgroundColor #FEFEFE
skinparam sequence {
    ArrowColor #495057
    LifeLineBorderColor #6C757D
}

title VonaTrigger â€” SDK çµ±åˆåˆ©ç”¨ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ï¼ˆè¬è§£ãã‚¤ãƒ™ãƒ³ãƒˆãƒ•ãƒ­ãƒ¼ï¼‰

actor "å‚åŠ è€…" as User
participant "ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒª\n(React)" as App #E3F2FD
participant "ã‚µãƒ¼ãƒãƒ¼" as Server #F5F5F5
participant "Verify SDK" as VerifySDK #FCE4EC
participant "Messages SDK" as MsgSDK #F3E5F5
participant "Voice SDK" as VoiceSDK #FFF3E0
participant "Video SDK" as VideoSDK #E8F5E9
participant "Vonage" as Vonage #ECEFF1
participant "AWS Bedrock\n(Claude)" as AI #FFF9C4

== Phase 1: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ² & é›»è©±ç•ªå·èªè¨¼ ==

User -> App : ã‚¢ãƒ—ãƒªèµ·å‹• & é›»è©±ç•ªå·å…¥åŠ›
App -> Server : POST /users/phone/register
Server -> VerifySDK : StartVerification(ctx, phone, nil)
VerifySDK -> Vonage : POST /verify/json
Vonage --> VerifySDK : request_id
Vonage -> User : SMSã€Œèªè¨¼ã‚³ãƒ¼ãƒ‰: 456789ã€
User -> App : ã‚³ãƒ¼ãƒ‰å…¥åŠ›
App -> Server : POST /users/phone/verify
Server -> VerifySDK : CheckVerification(ctx, reqID, code)
VerifySDK -> Vonage : POST /verify/check/json
Vonage --> VerifySDK : status: "0" (æˆåŠŸ)
Server --> App : âœ… é›»è©±ç•ªå·èªè¨¼å®Œäº†

== Phase 2: ã‚¤ãƒ™ãƒ³ãƒˆé–‹å§‹ & ã‚¦ã‚§ãƒ«ã‚«ãƒ ã‚³ãƒ¼ãƒ« ==

User -> App : ã‚¤ãƒ™ãƒ³ãƒˆå‚åŠ 
App -> Server : POST /ai/call/welcome

Server -> VoiceSDK : CreateCallWithNCCO(\n  ctx, phone,\n  TalkJapanese(welcomeMsg),\n  eventURL,\n)
VoiceSDK -> Vonage : POST /v1/calls
Vonage -> User : â˜ï¸ ã‚¦ã‚§ãƒ«ã‚«ãƒ ã‚³ãƒ¼ãƒ«\nã€Œã‚ˆã†ã“ãï¼è¬è§£ãã‚¤ãƒ™ãƒ³ãƒˆã¸ï¼ã€

== Phase 3: ã‚¹ãƒãƒƒãƒˆåˆ°ç€ & æ˜ åƒè¦–è´ ==

User -> App : ã‚¹ãƒãƒƒãƒˆã«åˆ°ç€ï¼ˆã‚¸ã‚ªãƒ•ã‚§ãƒ³ã‚¹æ¤œçŸ¥ï¼‰
App -> Server : POST /rooms/:spotId/enter

Server -> VideoSDK : CreateSession(ctx, nil)
VideoSDK -> Vonage : POST /session/create
Vonage --> VideoSDK : sessionId

Server -> VideoSDK : GenerateToken(sessionID).\n  Role(RolePublisher).Build()
VideoSDK --> Server : token

Server --> App : {sessionId, token}
App -> Vonage : WebRTC æ¥ç¶š â†’ æ˜ åƒè¦–è´ ğŸ¥

== Phase 4: AI ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¨ã®é€šè©± ==

User -> App : ã€Œãƒ’ãƒ³ãƒˆã‚’èãã€ãƒœã‚¿ãƒ³
App -> Server : POST /ai/call/initiate

Server -> VoiceSDK : CreateCallToPhone(\n  ctx, phone,\n  answerURL, eventURL,\n)
VoiceSDK -> Vonage : POST /v1/calls
Vonage -> User : â˜ï¸ ç€ä¿¡

Vonage -> Server : GET /answer (Webhook)
Server -> Server : NCCO Builder:\nTalkAndInputJapanese(\n  "ã”ç”¨ä»¶ã‚’ã©ã†ã",\n  inputURL,\n)
Server --> Vonage : NCCO

Vonage -> User : TTSã€Œã”ç”¨ä»¶ã‚’ã©ã†ãã€
User -> Vonage : ğŸ¤ã€Œæ±äº¬ã‚¿ãƒ¯ãƒ¼ã®ãƒ’ãƒ³ãƒˆã‚’ãã ã•ã„ã€
Vonage -> Server : POST /input (ASRçµæœ)

Server -> Server : asr.BestTranscript()
Server -> AI : AI å¿œç­”ç”Ÿæˆ
AI --> Server : "æ±äº¬ã‚¿ãƒ¯ãƒ¼ã®å±•æœ›å°ã‹ã‚‰..."

Server -> VoiceSDK : TalkIntoCall(\n  ctx, callUUID,\n  aiResponse, "Mizuki", 1,\n)
VoiceSDK -> Vonage : PUT /v1/calls/{uuid}/talk
Vonage -> User : TTSã€Œæ±äº¬ã‚¿ãƒ¯ãƒ¼ã®å±•æœ›å°ã‹ã‚‰...ã€

== Phase 5: ã‚¯ã‚¤ã‚ºæ­£è§£ & çµæœé€šçŸ¥ ==

User -> App : ã‚¯ã‚¤ã‚ºå›ç­”é€ä¿¡
App -> Server : POST /quizzes/:id/submit
Server -> Server : æ­£è§£åˆ¤å®š âœ…

Server -> MsgSDK : SendSMS(ctx, phone,\n  "ğŸ‰ æ­£è§£ï¼æ¬¡ã®ã‚¹ãƒãƒƒãƒˆã¯...",\n  WithClientRef("quiz-result"),\n)
MsgSDK -> Vonage : POST /v1/messages
Vonage -> User : SMSã€ŒğŸ‰ æ­£è§£ï¼æ¬¡ã®ã‚¹ãƒãƒƒãƒˆã¯...ã€

Server -> MsgSDK : NewMessage().\n  To(phone).WhatsApp().\n  Image(mapURL, "æ¬¡ã®ã‚¹ãƒãƒƒãƒˆåœ°å›³").\n  Send(ctx)
MsgSDK -> Vonage : POST /v1/messages
Vonage -> User : WhatsApp ç”»åƒã€Œæ¬¡ã®ã‚¹ãƒãƒƒãƒˆåœ°å›³ã€

@enduml
